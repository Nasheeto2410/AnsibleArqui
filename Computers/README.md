# 🖥️ Ansible – Computer Setup

This setup contains the Ansible playbooks used to initialize the configuration of all lab machines after the base operating system has been installed.

As you may remember from the [PXE Boot Project](https://github.com/IT-LAB-UAI/Documentation/blob/main/PXE/README.md), the OS installation defined **placeholder credentials** and default user accounts. This post-installation setup is responsible for finalizing that configuration.

## 🧩 Purpose

The main objectives of this setup are:

-   🔐 Change the default passwords that were set during OS provisioning
-   👤 Configure or promote users (e.g., assign sudo/admin roles)
-   🧑‍💻 Ensure all machines are reachable via SSH and ready for future automation

These tasks are designed to be executed **once**, immediately after PXE-based OS installation, and are meant to bring machines into their initial, secured, and managed state.

## ⚙️ Prerequisites

Before running this setup, you need to have an Ansible inventory that defines the hosts (lab machines) you want to configure.

You have two options for creating this inventory:

1. **Manual Creation** – You can manually define a static `hosts.ini` file with the IPs of your machines.

2. **Automated Scan** – You can use the [Host Scan Project](https://github.com/IT-LAB-UAI/Documentation/blob/main/Ansible/Setups/Hosts_Scan_Setup/README.md)  
   This project performs a network scan and generates an inventory file automatically.

> 📌 Make sure the inventory you're using correctly lists the reachable machines and SSH access is properly configured.

## 📁 Project Structure

For this playbook, we will use the `active_hosts.ini` file generated by the automated Host Scan project.

The directory layout is as follows:

```
Ansible
├── Outputs
│   └── Hosts_Scan_Output            # Previous project output directory
│       └── active_hosts.ini         # Inventory file generated by the Host Scan playbook
└── Setups
    └── Computers_Setups
        ├── ansible.cfg              # Ansible configuration file for this setup
        ├── add_hosts.yml            # Playbook to add known hosts and set up passwordless login
        ├── create_admin_user.yml    # Playbook to create and promote admin users
        └── secrets_computers_setup.yml  # Vault-encrypted file with sensitive variables (e.g. passwords)
```

### 🧾 File Descriptions

-   **`ansible.cfg`** – Defines inventory location and Ansible behavior for this specific setup.
-   **`add_hosts.yml`** – Adds discovered lab machines to the `known_hosts` file of the control node and sets up **passwordless SSH login** using the default (non-root) user defined during PXE provisioning.
-   **`create_admin_user.yml`** – Connects using the default user to create or promote a new admin account with sudo privileges.
-   **`secrets_computers_setup`** – A **vault-encrypted** file containing sensitive variables (e.g. SSH passwords, usernames).  
    This file must be decrypted at runtime with a vault password or key.

-   **`active_hosts.ini`** – The dynamic inventory exported by the Host Scan project. It lists all machines targeted by these playbooks.

> 📌 There is **no dedicated output directory** for this setup, as its actions are intended to apply configuration directly to target machines without generating local artifacts.

## 🔄 Project Workflow & Walkthrough

This section explains how the core components of this setup interact and how to prepare them before running any playbook.

### 🛠️ `ansible.cfg`

The `ansible.cfg` file is responsible for telling Ansible where to find your inventory.

It contains:

```
[defaults]
inventory = ../../Outputs/Hosts_Scan_Output/active_hosts.ini
```

This ensures Ansible always uses the inventory automatically generated by the **Host Scan** project.  
If you move the inventory file elsewhere, make sure to update this path accordingly.

---

## 🔐 `secrets_computers_setup` (Vault File)

This file contains all sensitive variables required by the playbooks in this setup.  
It must be encrypted using **Ansible Vault** and decrypted at runtime using a vault password.

Final variable structure (placeholders used instead of real values):

```yaml
---
# This file contains sensitive information and should not be shared publicly.

# Secrets for the add_hosts.yml playbook
ansible_user: <default_user> # Default username set during PXE provisioning (non-root)
target_group: <inventory_group_name> # The group of machines to which the SSH keys will be added

# Secrets for the create_admin_user.yml playbook
ansible_become_pass: <root_password> # Root password of the machines (for privilege escalation)
new_user_name: <admin_username> # New user account to be created
new_user_passwd: <admin_password> # Password for the new user (will be hashed)
```

### 🔐 Encrypting the File with Ansible Vault

To protect this file, use the following command:

```bash
ansible-vault encrypt secrets_computers_setup
```

To make changes later:

```bash
ansible-vault edit secrets_computers_setup
```

When running the playbooks, you will be prompted for the vault password:

```bash
ansible-playbook add_hosts.yml --ask-vault-pass
ansible-playbook create_admin_user.yml --ask-vault-pass
```

This file drives both playbooks and contains all credentials needed to:

-   Authenticate to lab machines as the default PXE user
-   Set up SSH key-based access for future automation
-   Create and elevate a permanent admin user

## 🔑 Playbook: `add_hosts.yml`

This playbook ensures that all target machines can be accessed via **passwordless SSH** using public key authentication. It performs two key tasks:

1. Updates the control node's `known_hosts` file to trust the hosts.
2. Deploys your public SSH key to each machine so that Ansible can connect without prompting for a password.

---

### ▶️ What It Does

This playbook runs in **two stages**:

#### 1. On `localhost`

-   **Cleans up old SSH fingerprints** from `~/.ssh/known_hosts` using `ssh-keygen -R`.
-   **Adds current SSH host keys** for all machines to `known_hosts` using `ssh-keyscan`.

#### 2. On All Hosts (`target_group`)

-   Pushes the control node’s **public SSH key** to the target machines using `ansible.posix.authorized_key`.
-   This key is added to the specified user’s `~/.ssh/authorized_keys` file.

---

### 🗂️ Playbook Location

```
Ansible/Setups/Computers_Setups/add_hosts.yml
```

---

### 🔐 Required Variables (from `secrets_computers_setup.yml`)

```yaml
ansible_user: <default_user> # User created during PXE provisioning (e.g., lab)
target_group: <inventory_group_name> # The group of hosts to configure
```

---

### 📋 Playbook Overview (With Task Code)

This playbook is divided into **two plays**, each with a specific role and tasks:

---

#### 🔹 Play 1: Update SSH Known Hosts

**Hosts:** `localhost`  
**Purpose:** Remove outdated fingerprints and collect fresh host keys from all machines.

**Metadata:**

```yaml
- name: Ensure known_hosts is clean and updated
  hosts: localhost
  gather_facts: false
  vars_files:
      - secrets_computers_setup.yml
```

---

**🔧 Task 1: Remove existing SSH keys**
Removes any old entries for the hosts in your `known_hosts` file to avoid SSH warnings or errors.

```yaml
- name: Remove existing SSH key from known_hosts (if present)
  ansible.builtin.shell: ssh-keygen -R {{ item }} || true
  args:
      executable: /bin/bash
  loop: "{{ groups[target_group] }}"
```

---

**🔧 Task 2: Add current SSH fingerprints**
Uses `ssh-keyscan` to fetch SSH fingerprints and append them to the known hosts file.

```yaml
- name: Add current host key to known_hosts
  ansible.builtin.shell: ssh-keyscan {{ item }} >> ~/.ssh/known_hosts
  args:
      executable: /bin/bash
  loop: "{{ groups[target_group] }}"
```

---

#### 🔹 Play 2: Set Up Passwordless SSH Access

**Hosts:** `all`  
**Purpose:** Distribute the control node’s public key to each host’s `authorized_keys` file.

**Metadata:**

```yaml
- name: Setup SSH Keys for login
  hosts: all
  vars_files:
      - secrets_computers_setup.yml
```

---

**🔧 Task 1: Add your public key to remote machines**
Enables passwordless SSH login for the default user.

```yaml
- name: Set SSH public key for user {{ ansible_user }}
  ansible.posix.authorized_key:
      user: "{{ ansible_user }}"
      state: present
      key: "{{ lookup('file', '~/.ssh/id_rsa.pub') }}"
```

---

### 📥 SSH Key Assumptions

This playbook assumes that the public key file exists at:

```
~/.ssh/id_rsa.pub
```

If this file does not exist, generate one with:

```bash
ssh-keygen -t rsa -b 4096
```

---

### 🚀 How to Run

Make sure the vault file is encrypted and ready. Then run:

```bash
ansible-playbook add_hosts.yml --ask-vault-pass
```

This will establish passwordless SSH access to all hosts defined under `target_group` in your inventory.

> 🛡️ **Note:** The playbook runs `ssh-keyscan`, which pulls host keys **without verifying** their authenticity. Use with caution in untrusted environments.

## 👤 Playbook: `create_admin_user.yml`

This playbook finalizes the post-installation setup of lab machines by **creating a dedicated admin user**, securing SSH access, and revoking `sudo` access from the temporary PXE-created user.

It assumes that **passwordless SSH access** is already configured (e.g., via the `add_hosts.yml` playbook), and that you're connecting using the **default PXE user with the ability to `su` to root** (i.e., you must know the root password).

---

### ▶️ What It Does

This playbook connects to each lab host using the **default PXE-created user** (e.g., `lab`) and performs the following tasks using `su` to escalate to root:

1. Creates a new user with `sudo` access.
2. Adds your public SSH key to that new user.
3. Removes `sudo` privileges from the original PXE user.

> 💡 This process uses `su` for privilege escalation — **the connecting user does not need to have sudo privileges**, only the ability to `su` to root (i.e., must know the root password).

### 🗂️ Playbook Location

```
Ansible/Setups/Computers_Setups/create_admin_user.yml
```

---

### 🔐 Required Variables (from `secrets_computers_setup.yml`)

```yaml
ansible_user: <default_user> # The initial PXE provisioned user (e.g., lab)
ansible_become_pass: <root_password> # Password for privilege escalation
new_user_name: <admin_username> # The new user to create (e.g., labadmin)
new_user_passwd: <admin_password> # Password to assign to the new user (will be hashed)
```

---

### 📋 Playbook Overview

This playbook contains a single play with multiple tasks. It runs as `root` using `become`.

---

#### 🔹 Play: Setup Admin User

**Hosts:** `all`  
**Escalation:** `become: yes`, using `su` to switch to `root`

**Metadata:**

```yaml
- name: Setup Admin User
  hosts: all
  become: yes
  become_method: su
  become_user: root
  vars_files:
      - secrets_computers_setup.yml
  vars:
      new_user_enc_password: "{{ new_user_passwd | password_hash('sha512') }}"
```

---

**🔧 Task 1: Create a new admin user**

This task creates the new administrative user and adds them to the `sudo` group.

```yaml
- name: Create labadmin User for configurations
  ansible.builtin.user:
      name: "{{ new_user_name }}"
      comment: Admin setup User
      password: "{{ new_user_enc_password }}"
      shell: /bin/bash
      groups: sudo
      append: yes
      create_home: yes
```

---

**🔧 Task 2: Set up SSH access for the new admin**

Copies your control node’s public key into the new admin’s `authorized_keys` file for passwordless login.

```yaml
- name: Setup the SSH key for new labadmin user
  ansible.posix.authorized_key:
      user: "{{ new_user_name }}"
      state: present
      key: "{{ lookup('file', '~/.ssh/id_rsa.pub') }}"
```

---

**🔧 Task 3: Revoke `sudo` from the default user**

Removes the PXE user (`lab`) from the `sudo` group, so only the new admin can escalate privileges.

---

### ⚠️ Important Notes

-   The `new_user_passwd` is **hashed with SHA-512** inside the playbook.
-   You must already have **SSH access** configured before running this playbook (via `add_hosts.yml`).
-   The public key must exist at `~/.ssh/id_rsa.pub` on the control node.

> 🔐 **Security Note:**  
> The `lab` user (created during PXE provisioning) does **not need to be in the `sudo` group** in the first place to run this playbook. However, this step is included as a **proactive security measure**, since the `lab` account is the **default user on all machines** and is publicly known.  
> Removing its administrative privileges helps reduce the attack surface of each machine in the lab.

---

### 🚀 How to Run the Playbook

Before running the playbook, make sure that:

-   Your **SSH public key** is available at `~/.ssh/id_rsa.pub`.
-   The file `secrets_computers_setup.yml` is **encrypted with Ansible Vault** and contains all required variables.
-   The target hosts are defined in the inventory (`active_hosts.ini`), and passwordless SSH is working for the PXE user (`lab`).

Run the playbook with:

```bash
ansible-playbook create_admin_user.yml --ask-vault-pass
```

This command will:

-   Prompt you for the **Vault password** to decrypt secrets.
-   Use the inventory defined in `ansible.cfg`.
-   Connect to each host as the PXE user (e.g., `lab`) and use `su` to switch to `root`.
-   Create the new admin user and remove elevated access from the PXE user.
